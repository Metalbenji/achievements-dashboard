<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achievement Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dark-bg: #0f0f14;
            --card-bg: rgba(26, 26, 31, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --achievement-gold: #ffd700;
            --neon-blue: #00d4ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        /* Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            z-index: 1000;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;            
            max-width: 1700px; /* Increased max-width */
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
        }

        .logo .icon {
            margin-right: 0.5rem;
        }

        .navbar-social-icons {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .social-icon-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            color: var(--text-secondary);
            background-color: transparent;
            border: 1px solid transparent;
            text-decoration: none;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .social-icon-button:hover {
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        .social-icon-button.twitch:hover {
            background-color: #9146ff;
            color: white;
            border-color: #9146ff;
        }
        .social-icon-button.kick:hover {
            background-color: #53fc18;
            color: black;
            border-color: #53fc18;
        }
        .social-icon-button.youtube:hover {
            background-color: #ff0000;
            color: white;
            border-color: #ff0000;
        }
        .social-icon-button.tiktok:hover {
            background-color: #010101;
            color: white;
            border-color: #010101;
        }
        .social-icon-button.x-twitter:hover {
            background-color: #000000;
            color: white;
            border-color: #000000;
        }
        .social-icon-button.kofi:hover {
            background-color: #FF5E5B;
            color: white;
            border-color: #FF5E5B;
        }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1700px; /* Increased max-width */
            margin-left: auto;
            margin-right: auto;
            flex: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent); /* Adjusted opacity slightly for a subtle static highlight if desired, or remove background entirely */
            /* animation: shine 3s infinite; */ /* Shine animation removed */
            pointer-events: none;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .user-input {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .user-input input {
            padding: 15px 25px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            background: var(--glass-bg);
            color: var(--text-primary);
            min-width: 250px;
            transition: all 0.3s ease;
        }

        .user-input input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .user-input input::placeholder {
            color: var(--text-secondary);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .progress-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .stat-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .filter-tabs {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 12px 25px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background: var(--glass-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .filter-tab:hover {
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .filter-tab.active {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
        }

        /* Achievement Cards - Styled like notification boxes */
        .achievements-grid {
            display: grid;
            grid-template-columns: 1fr; /* Default: single column for mobile-first approach */
            gap: 25px;
        }

        .achievement-card {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            border: 3px solid var(--neon-blue);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 
                0 0 30px rgba(0, 212, 255, 0.5),
                inset 0 0 20px rgba(0, 212, 255, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .achievement-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            /* background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent); */ /* Shine animation and its background removed */
            /* animation: shine 2s infinite; */ /* Shine animation removed */
            pointer-events: none;
        }

        .achievement-card.unlocked {
            border-color: var(--achievement-gold);
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.5),
                inset 0 0 20px rgba(255, 215, 0, 0.1);
            animation: glow 2s ease-in-out infinite alternate;
        }

        .achievement-card.locked {
            opacity: 0.6;
            border-color: rgba(0, 212, 255, 0.5);
            box-shadow: 
                0 0 15px rgba(0, 212, 255, 0.2),
                inset 0 0 10px rgba(0, 212, 255, 0.05);
        }

        .achievement-card:hover {
            transform: translateY(-5px);
        }

        .achievement-card.unlocked:hover {
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.7),
                inset 0 0 25px rgba(255, 215, 0, 0.2);
        }

        .achievement-header {
            display: flex;
            align-items: flex-start; /* Align tops of icon and info block */
            gap: 15px; /* Slightly adjusted gap */
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .achievement-icon {
            font-size: 4rem;
            flex-shrink: 0; /* Prevent icon from shrinking */
            filter: grayscale(100%);
            transition: all 0.3s ease;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            font-family: 'Orbitron', monospace;
        }

        .achievement-card.unlocked .achievement-icon {
            filter: none;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            animation: bounce 1s ease-in-out infinite alternate;
        }

        .achievement-info {
            flex-grow: 1; /* Allow info block to take available space */
            min-width: 0; /* Crucial for allowing text to wrap correctly in a flex item */
        }

        .achievement-info h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--neon-blue);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.8);
            font-family: 'Orbitron', monospace;
            overflow-wrap: break-word; /* Allow long words to break and wrap */
            word-wrap: break-word; /* Older alias for overflow-wrap */
        }

        .achievement-card.unlocked .achievement-info h3 {
            color: var(--achievement-gold);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }

        .achievement-info .rarity {
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px currentColor;
        }

        .rarity-1 { 
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 2px solid #ffffff;
        }
        .rarity-2 { 
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border: 2px solid #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }
        .rarity-3 { 
            background: rgba(0, 128, 255, 0.2);
            color: #0080ff;
            border: 2px solid #0080ff;
            box-shadow: 0 0 15px rgba(0, 128, 255, 0.5);
        }
        .rarity-4 { 
            background: rgba(128, 0, 255, 0.2);
            color: #8000ff;
            border: 2px solid #8000ff;
            box-shadow: 0 0 15px rgba(128, 0, 255, 0.5);
            animation: glow 1.5s ease-in-out infinite alternate;
        }
        .rarity-5 { 
            background: rgba(255, 128, 0, 0.2);
            color: #ff8000;
            border: 2px solid #ff8000;
            box-shadow: 0 0 20px rgba(255, 128, 0, 0.8);
            animation: legendary-glow 1.5s ease-in-out infinite alternate;
        }

        .achievement-description {
            margin-bottom: 20px;
            line-height: 1.5;
            color: #ffffff;
            opacity: 0.9;
            position: relative;
            z-index: 1;
            font-size: 1.1rem;
            overflow-wrap: break-word; /* Allow long words to break and wrap */
            word-wrap: break-word; /* Older alias for overflow-wrap */
        }

        .progress-bar {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 15px;
            height: 25px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--neon-blue), #0080ff, var(--achievement-gold));
            height: 100%;
            transition: width 0.8s ease;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }

        .achievement-card.unlocked .progress-fill {
            background: linear-gradient(90deg, var(--achievement-gold), #ff8000);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.3) 50%, transparent 70%);
            animation: progress-shine 2s infinite;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
            color: #ffffff;
            z-index: 2;
            font-family: 'Orbitron', monospace;
        }

        .unlock-date {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--achievement-gold);
            font-style: italic;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            position: relative;
            z-index: 1;
        }

        .error-message {
            background: var(--card-bg);
            border: 1px solid var(--danger);
            color: #ffcccc;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
            color: var(--text-primary);
            font-weight: 600;
        }

        .loading::after {
            content: "...";
            animation: pulse 1.5s infinite;
        }

        .achievement-group-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 40px; /* Space above title */
            margin-bottom: 20px; /* Space between title and grid */
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            text-align: left;
        }

        /* Adjust first group title's top margin if it's the first element in its container */
        #achievementsContainer > .achievement-group-title:first-child {
            margin-top: 0;
        }

        .no-achievements-message {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-secondary);
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: 12px;
            margin-top: 20px;
        }
        /* Footer */
        .app-footer {
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            margin-top: auto;
            position: relative;
            z-index: 500;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .footer-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-author {
            color: var(--text-primary);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1rem;
        }

        .footer-heart {
            color: #ff6b6b;
            animation: heartbeat 1.5s ease-in-out infinite;
            font-size: 0.9rem;
        }

        .footer-links {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .footer-version {
            background: var(--glass-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-weight: 500;
        }

        .footer-separator {
            opacity: 0.5;
        }

        .footer-tech {
            font-style: italic;
            opacity: 0.8;
        }

        /* Animations */
        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        @keyframes glow {
            0% { 
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), inset 0 0 20px rgba(255, 215, 0, 0.1);
            }
            100% { 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.8), inset 0 0 30px rgba(255, 215, 0, 0.2);
            }
        }

        @keyframes legendary-glow {
            0% { 
                box-shadow: 0 0 20px rgba(255, 128, 0, 0.4);
                transform: scale(1);
            }
            100% { 
                box-shadow: 0 0 30px rgba(255, 128, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.3);
                transform: scale(1.02);
            }
        }

        @keyframes bounce {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-15px) rotate(5deg); }
        }

        @keyframes progress-shine {
            0% { transform: translateX(-100%) skewX(-25deg); }
            100% { transform: translateX(100%) skewX(-25deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Responsive Grid: Apply multi-column layouts for wider screens (Mobile-First) */
        @media (min-width: 768px) { /* Tablets and small desktops */
            .achievements-grid {
                grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); /* Auto-fill columns */
            }
        }

        @media (min-width: 1400px) { /* Large desktops - Aim for 4 columns */
            .achievements-grid {
                grid-template-columns: repeat(4, 1fr); /* Explicitly 4 columns */
            }
        }

        /* General Responsive adjustments for smaller screens (<= 991px) */
        /* Note: .achievements-grid single column is now handled by its default style above */
        @media (max-width: 991px) { /* Adjusted breakpoint for wider portrait/tablet support */
            .navbar {
                padding: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .navbar-social-icons { 
                display: none; 
            }
            
            .user-input {
                flex-direction: column;
                align-items: center;
            }

            .user-input input,
            .user-input button {
                min-width: 280px;
            }

            .filter-tabs {
                flex-direction: column;
                align-items: center;
            }

            .filter-tab {
                min-width: 200px;
                text-align: center;
            }

            .app-footer { 
                padding: 1rem; 
                text-align: center; 
            }
            
            .footer-content { 
                flex-direction: column; 
                gap: 0.5rem; 
            }
            
            .footer-text { 
                justify-content: center; 
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-trophy icon"></i>
                Achievement Dashboard
            </div>
            <div class="navbar-social-icons">
                <a href="https://www.twitch.tv/metalbenji" target="_blank" class="social-icon-button twitch"
                    aria-label="Twitch">
                    <i class="fab fa-twitch"></i>
                </a>
                <a href="https://kick.com/metalbenji" target="_blank" class="social-icon-button kick"
                    aria-label="Kick">
                    <i class="fas fa-k"></i>
                </a>
                <a href="https://www.youtube.com/@metalbenji" target="_blank" class="social-icon-button youtube"
                    aria-label="YouTube">
                    <i class="fab fa-youtube"></i>
                </a>
                <a href="https://www.tiktok.com/@metalbenjigaming" target="_blank" class="social-icon-button tiktok"
                    aria-label="TikTok">
                    <i class="fab fa-tiktok"></i>
                </a>
                <a href="https://x.com/MetalBenji" target="_blank" class="social-icon-button x-twitter"
                    aria-label="X (formerly Twitter)">
                    <i class="fab fa-x-twitter"></i>
                </a>
                <a href="https://ko-fi.com/metalbenji" target="_blank" class="social-icon-button kofi"
                    aria-label="Buy me a beer">
                    <i class="fas fa-beer"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="header">
            <h1>🏆 Achievement Dashboard</h1>
            <p>Track your progress and unlock amazing achievements!</p>
            
            <div class="user-input">
                <input type="text" id="usernameInput" placeholder="Enter your Twitch username" />
                <button class="btn btn-primary" id="loadUserDataBtn">
                    <i class="fas fa-search"></i>
                    Load Progress
                </button>
            </div>
        </div>

        <div id="content">
            <div class="loading">Enter your username to view achievements</div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            <span class="footer-text">
                Made with <i class="fas fa-heart footer-heart"></i> by
                <strong class="footer-author">MetalBenji</strong>
            </span>
            <div class="footer-links">
                <span class="footer-version">Achievement Dashboard v1.0</span>
                <span class="footer-separator">•</span>
                <span class="footer-tech" id="randomFooterMessage">Powered by JavaScript & CSS Magic</span>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let allData = null;
        let currentFilter = 'all';
        let achievements = [];
        let userProgress = null;

        // DOM Element References
        let usernameInputElement;
        let contentElement;
        let randomFooterMessageElement;
        let loadUserDataButtonElement;

        // Random footer messages
        const footerMessages = [
            "Powered by a little energon, and a lot of luck",
            "Fueled by coffee and determination",
            "Powered by JavaScript & CSS Magic", // Added original default here
            "Built with love and late-night coding",
            "Powered by pure streaming magic",
            "Made with chaos and good intentions",
            "Fueled by hope and Red Bull",
            "Powered by the power of friendship",
            "Built on dreams and Stack Overflow",
            "Fueled by memes and determination",
            "Powered by 1s and 0s (mostly 0s)",
            "Made with bits, bytes, and vibes",
            "Fueled by subscriber energy",
            "Powered by follower notifications",
            "Built with stream love and code",
            "Fueled by chat encouragement"
        ];

        function setRandomFooterMessage() {
            if (randomFooterMessageElement) {
                const randomIndex = Math.floor(Math.random() * footerMessages.length);
                randomFooterMessageElement.textContent = footerMessages[randomIndex];
            }
        }

        // Load data from JSON file
        async function loadDataFromFile() {
            try {
                const response = await fetch('./data/achievements.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json();
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                showError("Failed to load achievement data. Please try again later.");
                return false;
            }
        }

        async function loadUserData() {
            if (!usernameInputElement) {
                console.error("Username input element not found.");
                return;
            }
            const username = usernameInputElement.value.trim();
            if (!username) {
                showError("Please enter a username");
                return;
            }

            showLoading();

            // Load data if not already loaded
            if (!allData) {
                const loaded = await loadDataFromFile();
                if (!loaded) return;
            }

            // Find user data
            const normalizedUsername = username.toLowerCase();
            let userObject = allData.users[normalizedUsername]; // Try direct lookup

            if (!userObject) { // If not found, try case-insensitive key search
                const foundKey = Object.keys(allData.users).find(key =>
                    key.toLowerCase() === normalizedUsername
                );
                if (foundKey) {
                    userObject = allData.users[foundKey];
                }
            }

            if (!userObject) {
                showError(`No achievement data found for user "${username}". Make sure you've participated in chat!`);
                return;
            }

            achievements = allData.achievements;
            // Convert to expected format
            userProgress = {
                Counters: userObject.counters || {},
                UnlockedAchievements: userObject.unlockedAchievements || [],
                LastUpdated: userObject.lastUpdated || new Date().toISOString()
            };

            displayDashboard();
        }

        function showLoading() {
            if(contentElement) contentElement.innerHTML = '<div class="loading">Loading achievements</div>';
        }

        function showError(message) {
            if(contentElement) contentElement.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function displayDashboard() {
            const unlockedCount = userProgress.UnlockedAchievements.length;
            const totalCount = achievements.length;
            const completionRate = ((unlockedCount / totalCount) * 100).toFixed(1);

            const content = `
                <div class="progress-overview">
                    <div class="stat-card">
                        <h3>🏆 Achievements</h3>
                        <div class="number">${unlockedCount}/${totalCount}</div>
                    </div>
                    <div class="stat-card">
                        <h3>📈 Completion</h3>
                        <div class="number">${completionRate}%</div>
                    </div>
                    <div class="stat-card">
                        <h3>💬 Messages</h3>
                        <div class="number">${userProgress.Counters.chat || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>💰 Bits</h3>
                        <div class="number">${userProgress.Counters.bits || 0}</div>
                    </div>
                </div>

                <div class="filter-tabs">
                    <button class="filter-tab ${currentFilter === 'all' ? 'active' : ''}" data-filter="all">All</button>
                    <button class="filter-tab ${currentFilter === 'unlocked' ? 'active' : ''}" data-filter="unlocked">Unlocked</button>
                    <button class="filter-tab ${currentFilter === 'locked' ? 'active' : ''}" data-filter="locked">Locked</button>
                    <button class="filter-tab ${currentFilter === 'chat' ? 'active' : ''}" data-filter="chat">Chat</button>
                    <button class="filter-tab ${currentFilter === 'sub' ? 'active' : ''}" data-filter="sub">Subscription</button>
                    <button class="filter-tab ${currentFilter === 'bits' ? 'active' : ''}" data-filter="bits">Bits</button>
                    <button class="filter-tab ${currentFilter === 'screenshot' ? 'active' : ''}" data-filter="screenshot">Screenshot</button>
                    <button class="filter-tab ${currentFilter === 'timewatched' ? 'active' : ''}" data-filter="timewatched">Time Watched</button>
                    <button class="filter-tab ${currentFilter === 'effect' ? 'active' : ''}" data-filter="effect">Effect</button>
                    <button class="filter-tab ${currentFilter === 'sound' ? 'active' : ''}" data-filter="sound">Sound</button>
                    <button class="filter-tab ${currentFilter === 'channelpoints' ? 'active' : ''}" data-filter="channelpoints">Channel Points</button>
                    <button class="filter-tab ${currentFilter === 'giftsub' ? 'active' : ''}" data-filter="giftsub">Gift Sub</button>
                    <button class="filter-tab ${currentFilter === 'donations' ? 'active' : ''}" data-filter="donations">Donations</button>
                    <button class="filter-tab ${currentFilter === 'giftbomb' ? 'active' : ''}" data-filter="giftbomb">Gift Bomb</button>
                </div>

                <div id="achievementsContainer">
                    ${renderAchievements()}
                </div>
            `;
            if (contentElement) {
                contentElement.innerHTML = content;

                // Add event listeners to new filter tabs
                contentElement.querySelectorAll('.filter-tab').forEach(button => {
                    button.addEventListener('click', function() {
                        setFilter(this.dataset.filter);
                    });
                });
                adjustSingleWordTitles(); // Call the function after rendering dashboard content
            }
        }

        // Special category mapping for specific achievements
        function getAchievementCategory(achievement) {
            const achievementName = achievement.Name.toLowerCase();
            
            // Time Watched category overrides
            if (achievementName.includes('night owl') || 
                achievementName.includes('early bird') || 
                achievementName.includes('weekend warrior')) {
                return 'timewatched';
            }
            
            // Effects category overrides
            if (achievementName.includes('transformation rookie') || 
                achievementName.includes('effect collector') || 
                achievementName.includes('transformation master') || 
                (achievementName.includes('shape') && achievementName.includes('shifting') && achievementName.includes('legend')) ||
                (achievementName.includes('shapeshifting') && achievementName.includes('legend'))) {
                return 'effect';
            }
            
            // Sound category overrides
            if (achievementName.includes('sound pioneer') || 
                achievementName.includes('chat dj') || 
                achievementName.includes('sound mixer')) {
                return 'sound';
            }
            
            // Channel Points category overrides
            if (achievementName.includes('point spender') || 
                achievementName.includes('big spender') || 
                achievementName.includes('whale spender') || 
                achievementName.includes('point millionaire')) {
                return 'channelpoints';
            }
            
            // Default to the achievement's original type
            return achievement.Type.toLowerCase().replace(/\s+/g, '').replace('-', '').replace('_', '');
        }

        // Currency conversion helper function (approximate conversion rate)
        function convertUSDtoGBP(usdAmount) {
            // Using approximate conversion rate - you may want to update this periodically
            const conversionRate = 0.79; // 1 USD = 0.79 GBP (approximate)
            return Math.round(usdAmount * conversionRate * 100) / 100; // Round to 2 decimal places
        }

        // Format currency value for display
        function formatCurrencyValue(value, isDonation) {
            if (isDonation) {
                const gbpValue = convertUSDtoGBP(value);
                return `£${gbpValue.toFixed(2)}`;
            }
            return value.toString();
        }

        // Helper function to map a single achievement to its HTML card
        function mapAchievementToHtml(achievement) {
            const isUnlocked = userProgress.UnlockedAchievements.includes(achievement.Id);
            // Use the special category mapping function
            const typeKey = getAchievementCategory(achievement);
            const counterKey = typeKey === 'timewatched' ? 'timewatched' : 
                              typeKey === 'channelpoints' ? 'channelpoints' : 
                              typeKey === 'giftsub' ? 'giftsub' : 
                              typeKey === 'giftbomb' ? 'giftbomb' : 
                              typeKey;
            
            const currentValue = userProgress.Counters[counterKey] || 0;
            const requiredValue = achievement.RequiredValue;
            const progress = Math.min((currentValue / requiredValue) * 100, 100);
            const displayedCurrentValue = Math.min(currentValue, requiredValue);
            
            // Check if this is a donation achievement for currency conversion
            const isDonation = typeKey === 'donations';
            
            // Format the progress text with currency conversion if needed
            const currentDisplayValue = formatCurrencyValue(displayedCurrentValue, isDonation);
            const requiredDisplayValue = formatCurrencyValue(requiredValue, isDonation);

            return `
                <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                    <div class="achievement-header">
                        <div class="achievement-icon">${achievement.Icon}</div>
                        <div class="achievement-info">
                            <h3>${achievement.Name}</h3>
                            <span class="rarity rarity-${achievement.Rarity}">★ Rarity ${achievement.Rarity}</span>
                        </div>
                    </div>
                    <div class="achievement-description">${achievement.Description}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                        <div class="progress-text">${currentDisplayValue}/${requiredDisplayValue}</div>
                    </div>
                    ${isUnlocked ? '<div class="unlock-date">✅ Unlocked!</div>' : ''}
                </div>
            `;
        }

        function renderAchievements() {
            let html = '';
            // These should match the data-filter values for type filters and be lowercase
            const definedAchievementTypes = ['chat', 'sub', 'bits', 'screenshot', 'timewatched', 'effect', 'sound', 'channelpoints', 'giftsub', 'donations', 'giftbomb']; 

            if (currentFilter === 'all') {
                const groupedByType = {};
                const miscellaneousAchievements = [];

                achievements.forEach(ach => {
                    const typeKey = getAchievementCategory(ach);
                    if (definedAchievementTypes.includes(typeKey)) {
                        if (!groupedByType[typeKey]) {
                            groupedByType[typeKey] = [];
                        }
                        groupedByType[typeKey].push(ach);
                    } else {
                        miscellaneousAchievements.push(ach);
                    }
                });

                // Define the order and display names for achievement groups
                const groupDisplayOrder = [
                    { key: 'chat', name: 'Chat' },
                    { key: 'sub', name: 'Subscription' },
                    { key: 'bits', name: 'Bits' },
                    { key: 'screenshot', name: 'Screenshot' },
                    { key: 'timewatched', name: 'Time Watched' },
                    { key: 'effect', name: 'Effect' },
                    { key: 'sound', name: 'Sound' },
                    { key: 'channelpoints', name: 'Channel Points' },
                    { key: 'giftsub', name: 'Gift Sub' },
                    { key: 'donations', name: 'Donations' },
                    { key: 'giftbomb', name: 'Gift Bomb' }
                ];

                groupDisplayOrder.forEach(group => {
                    if (groupedByType[group.key] && groupedByType[group.key].length > 0) {
                        html += `<h2 class="achievement-group-title">${group.name} Achievements</h2>`;
                        html += '<div class="achievements-grid">';
                        html += groupedByType[group.key].map(ach => mapAchievementToHtml(ach)).join('');
                        html += '</div>';
                    }
                });

                if (miscellaneousAchievements.length > 0) {
                    html += `<h2 class="achievement-group-title">Other Achievements</h2>`;
                    html += '<div class="achievements-grid">';
                    html += miscellaneousAchievements.map(ach => mapAchievementToHtml(ach)).join('');
                    html += '</div>';
                }

                if (html === '' && achievements.length > 0) { // User has progress, but no achievements fit groups (edge case)
                     html = '<p class="no-achievements-message">No achievements to display in defined categories.</p>';
                } else if (html === '' && achievements.length === 0) {
                     html = '<p class="no-achievements-message">No achievements are currently available.</p>';
                }

            } else { // Handle 'unlocked', 'locked', or specific type filters
                const filteredAchievements = achievements.filter(achievement => {
                    if (currentFilter === 'unlocked') return userProgress.UnlockedAchievements.includes(achievement.Id);
                    if (currentFilter === 'locked') return !userProgress.UnlockedAchievements.includes(achievement.Id);
                    const typeKey = getAchievementCategory(achievement);
                    return typeKey === currentFilter;
                });

                if (filteredAchievements.length > 0) {
                    if (definedAchievementTypes.includes(currentFilter)) {
                        const groupDisplayOrder = [
                            { key: 'chat', name: 'Chat' },
                            { key: 'sub', name: 'Subscription' },
                            { key: 'bits', name: 'Bits' },
                            { key: 'screenshot', name: 'Screenshot' },
                            { key: 'timewatched', name: 'Time Watched' },
                            { key: 'effect', name: 'Effect' },
                            { key: 'sound', name: 'Sound' },
                            { key: 'channelpoints', name: 'Channel Points' },
                            { key: 'giftsub', name: 'Gift Sub' },
                            { key: 'donations', name: 'Donations' },
                            { key: 'giftbomb', name: 'Gift Bomb' }
                        ];
                        const groupInfo = groupDisplayOrder.find(g => g.key === currentFilter);
                        const groupName = groupInfo ? groupInfo.name : currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1);
                        html += `<h2 class="achievement-group-title">${groupName} Achievements</h2>`;
                    }
                    html += '<div class="achievements-grid">';
                    html += filteredAchievements.map(ach => mapAchievementToHtml(ach)).join('');
                    html += '</div>';
                } else {
                    html = '<p class="no-achievements-message">No achievements match this filter.</p>';
                }
            }
            return html;
        }

        // Function to adjust font size of single-word titles if they overflow
        function adjustSingleWordTitles() {
            // Use a slight delay to ensure rendering is complete
            setTimeout(() => { // Increased timeout slightly
                const titleElements = contentElement ? contentElement.querySelectorAll('.achievement-info h3') : [];
                const minFontSize = 10; // Minimum font size in pixels
                const step = 0.5; // How much to decrease font size each iteration (in px)

                titleElements.forEach(h3 => {
                    // Reset inline font size to revert to CSS-defined size before recalculating
                    // This is important if the function runs multiple times on the same elements (e.g., after filtering)
                    h3.style.fontSize = ''; 

                    const text = h3.textContent.trim();
                    const isSingleWord = text.indexOf(' ') === -1;
                    const keywordsToShrink = ['transformation', 'transcendent'];
                    const containsShrinkKeyword = keywordsToShrink.some(keyword => text.toLowerCase().includes(keyword));

                    // Apply shrinking if it's a single word OR contains one of the specified keywords
                    if (isSingleWord || containsShrinkKeyword) {
                        // Get the font size as defined by CSS (now that inline is cleared)
                        const originalComputedStyle = window.getComputedStyle(h3);
                        let currentFontSize = parseFloat(originalComputedStyle.fontSize);

                        // Store original inline white-space style
                        const originalInlineWhiteSpace = h3.style.whiteSpace;

                        // Temporarily force single line to measure true content width
                        h3.style.whiteSpace = 'nowrap';

                        // Check for overflow
                        if (h3.scrollWidth > h3.clientWidth) {
                            // Iteratively reduce font size
                            while (h3.scrollWidth > h3.clientWidth && currentFontSize > minFontSize) {
                                currentFontSize -= step;
                                if (currentFontSize < minFontSize) {
                                    currentFontSize = minFontSize; // Don't go below min
                                }
                                h3.style.fontSize = `${currentFontSize}px`;
                                
                                // If we hit minFontSize and it's still overflowing, break to prevent infinite loop on impossible fits
                                if (currentFontSize === minFontSize && h3.scrollWidth > h3.clientWidth) {
                                    break; 
                                }
                            }
                        }
                        
                        // Restore original inline white-space style.
                        // This allows CSS `overflow-wrap: break-word` to take over if:
                        // 1. It wasn't a single overflowing word initially.
                        // 2. It was a single word, but even at minFontSize, it still overflowed.
                        h3.style.whiteSpace = originalInlineWhiteSpace;
                        
                        // Uncomment for debugging specific titles:
                        // if (text.toLowerCase().includes("conversationalist")) {
                        //     console.log(`${text}: scrollW=${h3.scrollWidth}, clientW=${h3.clientWidth}, finalFS=${h3.style.fontSize || currentFontSize}`);
                        // }
                    }
                }); // End forEach
            }, 200); 
        }
        function setFilter(filter) {
            currentFilter = filter;
            displayDashboard();
        }

        // Handle Enter key in username input
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DOM element references
            usernameInputElement = document.getElementById('usernameInput');
            contentElement = document.getElementById('content');
            randomFooterMessageElement = document.getElementById('randomFooterMessage');
            loadUserDataButtonElement = document.getElementById('loadUserDataBtn');

            if (usernameInputElement) {
                usernameInputElement.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loadUserData();
                    }
                });
            }

            if (loadUserDataButtonElement) {
                loadUserDataButtonElement.addEventListener('click', loadUserData);
            }

            if (randomFooterMessageElement) {
                setRandomFooterMessage(); // Set initial random footer message
            }
        });
    </script>
</body>
</html>
